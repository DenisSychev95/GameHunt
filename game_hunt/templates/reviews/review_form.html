{% extends "base.html" %}
{% block title %}
  {% if review %}GameHunt — Редактировать обзор{% else %}GameHunt — Новый обзор{% endif %}
{% endblock %}

{% block content %}
<section style="max-width: 900px; margin: 0 auto;">

  <p style="margin-bottom: 10px;">
    <a href="{% url 'game_detail' slug=game.slug %}" style="color:#9ca3af;">← {{ game.title }}</a>
    ·
    <a href="{% url 'review_list' %}?game={{ game.slug }}" style="color:#9ca3af;">Обзоры этой игры</a>
  </p>

  <h2 style="color:#f97316; margin: 0 0 10px;">
    {% if review %}Редактировать обзор{% else %}Новый обзор{% endif %}: {{ game.title }}
  </h2>

  {% if form.errors or formset.non_form_errors %}
    <div style="border:1px solid #ef4444; border-radius:10px; padding:12px; margin: 12px 0; color:#fecaca;">
      <p style="margin:0 0 6px;"><strong>Исправь ошибки в форме:</strong></p>
      {{ form.non_field_errors }}
      {{ formset.non_form_errors }}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" style="margin-top: 12px;">
    {% csrf_token %}

    <!-- Основная форма обзора -->
    <div style="border:1px solid #374151; border-radius:12px; padding:14px;">
      <h3 style="margin:0 0 10px; color:#e5e7eb;">Текст обзора</h3>

      <div style="display:flex; flex-direction:column; gap:12px;">

        <div>
          <label for="{{ form.title.id_for_label }}">Заголовок</label><br>
          {{ form.title }}
          <div style="color:#fca5a5;">{{ form.title.errors }}</div>
        </div>

        <div>
          <label for="{{ form.summary.id_for_label }}">TL;DR (коротко)</label><br>
          {{ form.summary }}
          <div style="color:#fca5a5;">{{ form.summary.errors }}</div>
          <div style="color:#9ca3af; font-size:13px; margin-top:4px;">
            1–3 предложения: кому зайдёт / кому не зайдёт
          </div>
        </div>

        <div>
          <label for="{{ form.text.id_for_label }}">Основной текст</label><br>
          {{ form.text }}
          <div style="color:#fca5a5;">{{ form.text.errors }}</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div>
            <label for="{{ form.pros.id_for_label }}">Плюсы</label><br>
            {{ form.pros }}
            <div style="color:#fca5a5;">{{ form.pros.errors }}</div>
            <div style="color:#9ca3af; font-size:13px; margin-top:4px;">
              Каждый пункт — с новой строки
            </div>
          </div>

          <div>
            <label for="{{ form.cons.id_for_label }}">Минусы</label><br>
            {{ form.cons }}
            <div style="color:#fca5a5;">{{ form.cons.errors }}</div>
            <div style="color:#9ca3af; font-size:13px; margin-top:4px;">
              Каждый пункт — с новой строки
            </div>
          </div>
        </div>

        <div>
          <label for="{{ form.conclusion.id_for_label }}">Итог</label><br>
          {{ form.conclusion }}
          <div style="color:#fca5a5;">{{ form.conclusion.errors }}</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div>
            <label for="{{ form.rating.id_for_label }}">Оценка</label><br>
            {{ form.rating }}
            <div style="color:#fca5a5;">{{ form.rating.errors }}</div>
          </div>

          <div>
            <label for="{{ form.video_url.id_for_label }}">Ссылка на видео (опционально)</label><br>
            {{ form.video_url }}
            <div style="color:#fca5a5;">{{ form.video_url.errors }}</div>
          </div>
        </div>

      </div>
    </div>

    <!-- Formset для картинок -->
    <div style="margin-top: 16px; border:1px solid #374151; border-radius:12px; padding:14px;">
      <h3 style="margin:0 0 10px; color:#e5e7eb;">Картинки к обзору</h3>
      <p style="margin:0 0 10px; color:#9ca3af; font-size:13px;">
        Добавь несколько скриншотов. Поле <b>order</b> определяет порядок (0,1,2...).
      </p>

      <!-- ОБЯЗАТЕЛЬНО -->
      {{ formset.management_form }}<div style="display:flex; flex-direction:column; gap:12px;">
        {% for f in formset %}
          <div style="border:1px solid #374151; border-radius:10px; padding:12px;">
            {{ f.non_field_errors }}

            <div style="display:grid; grid-template-columns: 1.2fr 1fr; gap:12px; align-items:start;">
              <div>
                <label>Файл изображения</label><br>
                {{ f.image }}
                <div style="color:#fca5a5;">{{ f.image.errors }}</div>

                {% if f.instance.pk and f.instance.image %}
                  <div style="margin-top:10px;">
                    <img src="{{ f.instance.image.url }}"
                         alt=""
                         style="max-width: 100%; height: 160px; object-fit: cover; border-radius: 8px; border:1px solid #374151;">
                  </div>
                {% endif %}
              </div>

              <div>
                <div>
                  <label>Подпись</label><br>
                  {{ f.caption }}
                  <div style="color:#fca5a5;">{{ f.caption.errors }}</div>
                </div>

                <div style="margin-top:10px;">
                  <label>Порядок (order)</label><br>
                  {{ f.order }}
                  <div style="color:#fca5a5;">{{ f.order.errors }}</div>
                </div>

                {% if f.instance.pk %}
                  <div style="margin-top:12px;">
                    {{ f.DELETE }}
                    <label for="{{ f.DELETE.id_for_label }}" style="color:#ef4444;">
                      Удалить эту картинку
                    </label>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div style="color:#9ca3af; font-size:13px; margin-top:10px;">
        Нужно больше полей под картинки? В forms.py увеличь <code>extra</code> в <code>ReviewImageFormSet</code>.
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top: 16px; align-items:center;">
      <button type="submit"
              style="padding: 8px 14px; background:#f97316; color:#fff; border:none; border-radius:6px;">
        {% if review %}Сохранить изменения{% else %}Опубликовать обзор{% endif %}
      </button>

      {% if review %}
        <a href="{% url 'review_detail' review.pk %}" style="color:#9ca3af;">Отмена</a>
      {% else %}
        <a href="{% url 'game_detail' slug=game.slug %}" style="color:#9ca3af;">Отмена</a>
      {% endif %}
    </div>

  </form>
</section>
{% endblock %}