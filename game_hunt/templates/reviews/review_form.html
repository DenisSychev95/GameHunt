{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if review %}GameHunt — Редактировать обзор{% else %}GameHunt — Новый обзор{% endif %}
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/review_form.css' %}">
{% endblock %}

{% block content %}
<section class="gd-review-container">

  {# сверху: одна ссылка "стрелка влево к обзору" #}
  <p class="gd-review-topline">
    <a class="gd-back-link"
       href="{% if review %}{% url 'review_detail' review.pk %}{% else %}{% url 'review_list' %}?game={{ game.slug }}{% endif %}">
      ← к обзору
    </a>
  </p>

  <h2 class="gd-review-title">
    {% if review %}Редактировать обзор{% else %}Новый обзор{% endif %}: {{ game.title }}
  </h2>

  {% if form.errors or formset.non_form_errors %}
    <div class="gd-form-errors">
      <p class="gd-form-errors-title"><strong>Исправь ошибки в форме:</strong></p>
      {{ form.non_field_errors }}
      {{ formset.non_form_errors }}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="gd-review-form">
    {% csrf_token %}

    {# ВАЖНО для CKEditor/виджетов: #}
    {{ form.media }}
    {{ formset.media }}

    <!-- Основная форма обзора -->
    <div class="gd-card">
      <h3 class="gd-card-title">Текст обзора</h3>

      <div class="gd-fields">

        <div class="gd-field">
          <label for="{{ form.title.id_for_label }}">Заголовок</label>
          {{ form.title }}
          <div class="gd-field-error">{{ form.title.errors }}</div>
        </div>

        <div class="gd-field">
          <label for="{{ form.summary.id_for_label }}">TL;DR (коротко)</label>

          <div class="gd-review-scroll">
            {{ form.summary }}
          </div>

          <div class="gd-field-error">{{ form.summary.errors }}</div>
          <div class="gd-field-help">
            1–3 предложения: кому зайдёт / кому не зайдёт
          </div>
        </div>

        <div class="gd-field">
          <label for="{{ form.text.id_for_label }}">Основной текст</label>

          <div class="gd-review-scroll">
            {{ form.text }}
          </div>

          <div class="gd-field-error">{{ form.text.errors }}</div>
        </div>

        <div class="gd-grid-2">
          <div class="gd-field">
            <label for="{{ form.pros.id_for_label }}">Плюсы</label>
            {{ form.pros }}
            <div class="gd-field-error">{{ form.pros.errors }}</div>
            <div class="gd-field-help">Каждый пункт — с новой строки</div>
          </div>

          <div class="gd-field">
            <label for="{{ form.cons.id_for_label }}">Минусы</label>
            {{ form.cons }}
            <div class="gd-field-error">{{ form.cons.errors }}</div>
            <div class="gd-field-help">Каждый пункт — с новой строки</div>
          </div>
        </div>

        <div class="gd-field">
          <label for="{{ form.conclusion.id_for_label }}">Итог</label>

          <div class="gd-review-scroll">
            {{ form.conclusion }}
          </div>

          <div class="gd-field-error">{{ form.conclusion.errors }}</div>
        </div>

        <div class="gd-grid-2">
          <div class="gd-field">
            <label for="{{ form.rating.id_for_label }}">Оценка</label>
            {{ form.rating }}
            <div class="gd-field-error">{{ form.rating.errors }}</div>
          </div>

          <div class="gd-field">
            <label for="{{ form.video_url.id_for_label }}">Ссылка на видео (опционально)</label>
            {{ form.video_url }}
            <div class="gd-field-error">{{ form.video_url.errors }}</div>
          </div>
        </div>

      </div>
    </div>

    <!-- Formset для картинок -->
    <div class="gd-card gd-card-spaced">
      <h3 class="gd-card-title">Картинки к обзору</h3>
      <p class="gd-muted">
        Добавь несколько скриншотов. Поле <b>order</b> определяет порядок (0,1,2...).
      </p>

      <!-- ОБЯЗАТЕЛЬНО -->
      {{ formset.management_form }}

      <div class="gd-formset">
        {% for f in formset %}
          <div class="gd-formset-item">
            {{ f.non_field_errors }}

            <div class="gd-formset-grid">
              <div class="gd-field">
                <label>Файл изображения</label>
                {{ f.image }}
                <div class="gd-field-error">{{ f.image.errors }}</div>

                {% if f.instance.pk and f.instance.image %}
                  <div class="gd-preview">
                    <img src="{{ f.instance.image.url }}" alt="" class="gd-preview-img">
                  </div>
                {% endif %}
              </div>

              <div>
                <div class="gd-field">
                  <label>Подпись</label>
                  {{ f.caption }}
                  <div class="gd-field-error">{{ f.caption.errors }}</div>
                </div>

                <div class="gd-field gd-mt-10">
                  <label>Порядок (order)</label>
                  {{ f.order }}
                  <div class="gd-field-error">{{ f.order.errors }}</div>
                </div>

                {% if f.instance.pk %}
                  <div class="gd-delete gd-mt-12">
                    {{ f.DELETE }}
                    <label for="{{ f.DELETE.id_for_label }}" class="gd-delete-label">
                      Удалить эту картинку
                    </label>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="gd-muted gd-mt-10">
        Нужно больше полей под картинки? В forms.py увеличь <code>extra</code> в <code>ReviewImageFormSet</code>.
      </div>
    </div>

    <div class="gd-actions">
      <button type="submit" class="gd-btn-primary">
        {% if review %}Сохранить изменения{% else %}Опубликовать обзор{% endif %}
      </button>

      {% if review %}
        <a href="{% url 'review_detail' review.pk %}" class="gd-link-secondary gd-formset-link">Отмена</a>
      {% else %}
        <a href="{% url 'game_detail' slug=game.slug %}" class="gd-link-secondary gd-formset-link">Отмена</a>
      {% endif %}
    </div>

  </form>
</section>
{% endblock %}

{% block extra_js %}
  {# если CKEditor подключается вручную — оставь этот файл, он безопасный: #}
  <script src="{% static 'js/review_form.js' %}"></script>
{% endblock %}
