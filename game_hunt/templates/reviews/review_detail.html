{% extends "base.html" %}
{% load static %}

{% block title %}GameHunt — {{ review.title }}{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/reviews.css' %}">
{% endblock %}
{% block content %}
<section class="gd">

<!-- Topbar (только для review_detail) -->
<div class="gd-topbar">

  <!-- LEFT: 2 ссылки -->
  <div class="gd-topbar-left">
    <a class="gd-back" href="{% url 'game_detail' slug=review.game.slug %}" title="Перейти к игре">
      <span class="ui-icon ui-icon-arrow-double-left" aria-hidden="true"></span>
      <span>{{ review.game.title }}</span>
    </a>

    <a class="gd-back" href="{% url 'review_list' %}" title="Перейти к обзорам">
      <span class="ui-icon ui-icon-arrow-left" aria-hidden="true"></span>
      <span>Все обзоры</span>
    </a>
  </div>

  <!-- RIGHT: share + edit/delete -->
  <div class="gd-topbar-right">
    <button class="gd-share" type="button" data-share title="Скопировать ссылку">
      <span class="ui-icon ui-icon-share" aria-hidden="true"></span>
      <span>Поделиться</span>
    </button>

    {% if user.is_authenticated and user == review.author or user.is_authenticated and user.is_staff or user.is_authenticated and user.is_superuser %}
      <a class="gd-share" href="{% url 'review_edit' review.pk %}?next={{ request.path }}" title="Редактировать обзор">
        <svg class="gd-ico gd-ico-edit" viewBox="0 0 24 24" aria-hidden="true">
    <path fill="currentColor"
      d="M3 17.25V21h3.75L17.8 9.95l-3.75-3.75L3 17.25zm18-11.5
         a1 1 0 0 0 0-1.41l-1.59-1.59
         a1 1 0 0 0-1.41 0l-1.83 1.83
         3.75 3.75L21 5.75z"/>
  </svg>
      </a>

      <a class="gd-share"
   href="{% url 'review_delete' review.pk %}?next={{ request.path }}"
   title="Удалить обзор">
  <svg class="gd-ico gd-ico-trash" viewBox="0 0 24 24" aria-hidden="true">
    <path fill="currentColor"
          d="M6 7h12l-1 13H7L6 7zm3-3h6l1 2H8l1-2z"/>
  </svg>
</a>
    {% endif %}
  </div>

</div>

  <!-- Title -->
  <header class="gd-header">
    <h1 class="gd-title center">{{ review.title }}</h1>

    {# Обложка обзора: если есть cover_image в Review — подхватит его, иначе обложка игры #}
    <div class="center-image">
      {% if review.cover_image %}
        <img class="gd-cover review" src="{{ review.cover_image.url }}" alt="{{ review.title }}">
      {% elif review.game.cover_image %}
        <img class="gd-cover review" src="{{ review.game.cover_image.url }}" alt="{{ review.game.title }}">
      {% endif %}
    </div>

    <p class="gd-hint center">
      <span class="gd-meta-value">Обновлено:</span> {{ review.updated_at|date:"d.m.Y" }}
    </p>

    <div class="gd-nav review-nav">
      <div class="gd-nav-left">
        <span class="gd-meta-value">Автор:</span>
        <a class="gd-comment-author" href="{% url 'profile-view' review.author.id %}">
          {{ review.author.profile.nickname|default:review.author.username }}
        </a>
      </div>

      <div class="gd-nav-right">
        <span class="gd-meta-value">Оценка:</span>
        <span class="rating-text review-rating">{{ review.rating }}/10</span>
      </div>
    </div>
  </header>

  <!-- Введение -->
  {% if review.summary %}
    <section class="gd-block">
      <h2 class="gd-section-title center">Описание</h2>
      <div class="gd-text">{{ review.summary }}</div>
    </section>
  {% endif %}

{% if review.images.all %}
<section class="gd-gallery" data-gallery-root data-page-size="5">
  <h2 class="gd-section-title">Галерея</h2>

  <div class="gd-carousel">
    <button class="gd-carousel-btn is-hidden" type="button" data-prev aria-label="Назад">‹</button>

    <div class="gd-carousel-viewport">
      <div class="gd-carousel-track">
        {% for img in review.images.all %}
          <a href="{{ img.image.url }}"
             class="gd-thumb glightbox"
             data-gallery="review-{{ review.id }}"
             data-title="{{ img.caption|default:'' }}"
             data-index="{{ forloop.counter0 }}">
            <img src="{{ img.image.url }}" alt="{{ img.caption|default:review.title }}">
          </a>
        {% endfor %}
      </div>
    </div>

    <button class="gd-carousel-btn is-hidden" type="button" data-next aria-label="Вперёд">›</button>
  </div>

  <p class="gd-hint" data-counter></p>
</section>
{% endif %}

  <!-- Содержание (скролл-блок) -->
  <section class="gd-block">


    <div class="gd-review-scroll">
      {# Если CKEditor — нужно safe #}
      <div class="gd-text">{{ review.text|safe }}</div>
    </div>
  </section>

  <!-- Плюсы / Минусы -->
  <section class="gd-block">
    <div class="gd-procons">
      <div class="gd-pros">
        <h2 class="gd-subtitle center">Плюсы</h2>
        <div class="gd-text indent">{{ review.pros|linebreaks }}</div>
      </div>
      <div class="gd-cons">
        <h2 class="gd-subtitle center">Минусы</h2>
        <div class="gd-text indent">{{ review.cons|linebreaks }}</div>
      </div>
    </div>

    {% if review.conclusion %}
      <div class="gd-conclusion">
        <h2 class="gd-subtitle center">Выводы</h2>
        <div class="gd-text">{{ review.conclusion }}</div>
      </div>
    {% endif %}
  </section>

  <!-- Видео (как в game_detail: iframe,  trailer_embed) -->
  {% if trailer_embed %}
    <section class="gd-block">
      <h2 class="gd-section-title center">Видео-обзор</h2>
      <div class="gd-video">
        <iframe
          src="{{ trailer_embed }}"
          title="Видео"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen>
        </iframe>
      </div>
    </section>
  {% endif %}
<section class="gd-block">


        <div class="gd-vote">
            {% if user.is_authenticated %}
            <h4 class="gd-section-title">Пожалуйста, оцените контент</h4>
            <form method="post" action="{% url 'review_vote' review.pk %}" class="gd-vote-row">
                {% csrf_token %}

                {% with v=user_vote.value|default_if_none:0 %}
                <button
                        class="gd-vote-btn gd-vote-like {% if v == 1 %}is-active{% endif %}"
                        name="value" value="1" type="submit"
                        aria-pressed="{% if v == 1 %}true{% else %}false{% endif %}"
                >
            <span class="gd-vote-icon" aria-hidden="true">
              <!-- Heart -->
              <svg class="gd-ico gd-ico-heart"
     viewBox="0 0 24 24"
     width="24"
     height="24"
     aria-hidden="true"
     focusable="false">
  <path fill="currentColor"
        d="M12 20
           C12 20, 4 14.5, 4 9.5
           C4 7, 6 5.5, 8.5 5.5
           C10 5.5, 11.5 6.5, 12 7.8
           C12.5 6.5, 14 5.5, 15.5 5.5
           C18 5.5, 20 7, 20 9.5
           C20 14.5, 12 20, 12 20
           Z"/>
</svg>
            </span>

                </button>

                <button
                        class="gd-vote-btn gd-vote-dislike {% if v == -1 %}is-active{% endif %}"
                        name="value" value="-1" type="submit"
                        aria-pressed="{% if v == -1 %}true{% else %}false{% endif %}"
                >
            <span class="gd-vote-icon" aria-hidden="true">
              <!-- Emotional sad face -->
              <svg class="gd-ico-sad" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" focusable="false">
  <circle class="face" cx="12" cy="12" r="9"/>

  <!-- глаза -->
  <circle class="features" cx="9.4" cy="11.1" r="3"/>
  <circle class="features" cx="14.6" cy="11.1" r="3"/>

  <!-- блики (всегда белые) -->
  <circle class="sparkle" cx="8.9" cy="10.6" r="1.1"/>
  <circle class="sparkle" cx="14.1" cy="10.6" r="1.1"/>

  <!-- рот -->
  <path class="mouth" d="M9.4 16.1c.85-.55 1.7-.8 2.6-.8s1.75.25 2.6.8"
        fill="none" stroke-width="2" stroke-linecap="round"/>
</svg>
            </span>

                </button>
                {% endwith %}
            </form>

            {% if not user_vote %}
            <p class="gd-hint">Учитывается только одно мнение пользователя, но его можно изменить.</p>
            {% endif %}

            {% else %}
            <p class="gd-hint">Для оценки контента нужно <a class="btn gd-view_content auth-link" href="{% url 'account_login' %}">войти</a></p>
            {% endif %}
            <div class="gd-vote-toast" role="status" aria-live="polite"></div>
        </div>
    </section>


  <!-- Комментарии (скролл списка как в game_detail) -->
  <section class="gd-comments">
    {% if user.is_authenticated %}
      <section class="gd-comment-box">
        <h2 class="gd-section-title center">Оставить комментарий</h2>

        <form id="comment-form"
              class="gd-comment-form"
              action="{% url 'review_add_comment' review.pk %}"
              method="post">
          {% csrf_token %}

          <textarea id="comment-text"
                    name="text"
                    maxlength="500"
                    placeholder="Ваш комментарий..."
                    required></textarea>

          <div class="gd-comment-footer">
            <button id="comment-submit"
                    class="btn gd-view_content"
                    type="submit"
                    disabled>
              Отправить</button>
          </div>
        </form>
      </section>
    {% else %}
      <p class="gd-hint center">Чтобы оставить комментарий, нужно <a class="btn gd-view_content auth-link" href="{% url 'account_login' %}">войти</a></p>
    {% endif %}
    <h2 class="gd-section-title center">Комментарии</h2>

    <div id="comment-list" class="gd-comment-list {% if comments|length > 6 %}gd-comment-list--scroll{% endif %}">
      {% for comment in comments %}
        {% include "reviews/partials/review_comment.html" with comment=comment %}
      {% empty %}
        <p class="gd-hint">Будьте первым, кто оставит комментарий.</p>
      {% endfor %}
    </div>


  </section>

</section>






{% endblock %}


{% block page_js %}
  <script src="{% static 'js/review_detail.js' %}"></script>
{% endblock %}