{% extends "base.html" %}
{% load static %}
{% block title %}GameHunt — Обзоры{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/reviews.css' %}">
{% endblock %}
{% block content %}
<section class="container">

  <h1 class="page-title center">Обзоры</h1>


  <!-- Панель: слева поиск по названию игры, рядом сортировка -->
  <form method="get" class="search-form">
    <input class="input"
           type="text"
           name="game_search"
           placeholder="Поиск обзоров"
           value="{{ game_search|default:'' }}">

    <select class="select" name="sort">
      <option value="new" {% if current_sort == "new" %}selected{% endif %}>Сначала новые</option>
      <option value="popular" {% if current_sort == "popular" %}selected{% endif %}>Популярные</option>
      <option value="rating" {% if current_sort == "rating" %}selected{% endif %}>По оценке</option>
    </select>

    <button class="btn" type="submit">Найти</button>

    {% if game_search or current_sort != "new" %}
      <a class="link-muted" href="{% url 'review_list' %}">Сброс</a>
    {% endif %}
  </form>

  {% if reviews %}
    <div class="game-grid">
      {% for review in reviews %}
        {% if review.is_published %}
        <article class="game-card">

          <div class="game-head">
            <h3 class="game-title">
              <a href="{% url 'review_detail' review.pk %}">{{ review.title|truncatechars:34 }}</a>
            </h3>

            <div class="game-views" title="Просмотры">
              <span class="ui-meta">
                <span class="ui-icon ui-icon-eye"></span>
                {{ review.views_count }}
              </span>
            </div>
          </div>
          <!-- Обложка = обложка игры -->
          {# Обложка = обложка игры #}
          <a href="{% url 'review_detail' review.pk %}" class="game-cover-link">
            {% if review.game.cover_image %}
              <img class="game-cover" src="{{ review.game.cover_image.url }}" alt="{{ review.title }}">
            {% else %}
              <div class="game-cover-placeholder">Нет обложки</div>
            {% endif %}
          </a>
          <!-- Название игры — ссылка (без слова "Игра") -->
          <div class="game-meta">
            <a class="genre-link"  href="{% url 'game_detail' slug=review.game.slug %}">{{ review.game.title }}</a>
          </div>

          {# Понравилось% + оценка обзора #}
          <div class="game-stats">
            <div class="like-love" title="Понравилось пользователям">
              <svg class="icon-love" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 21s-7.5-4.35-10.5-9C-0.7 8.1 1.6 4 5.5 4
                         c2.2 0 4.1 1.2 5 3 0.9-1.8 2.8-3 5-3
                         3.9 0 6.2 4.1 4 8-3 4.65-10.5 9-10.5 9z"/>
              </svg>
              <span class="like-value">{{ review.liked_percent }}%</span>
            </div>

            <div class="rating-badge" title="Оценка обзора">
              <svg class="icon-star" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 17.3L18.2 21l-1.6-7L22 9.2l-7.2-.6L12 2
                         9.2 8.6 2 9.2 7.4 14 5.8 21z"/>
              </svg>
              <span class="rating-text">{{ review.rating }}/10</span>
            </div>
          </div>

          {# Автор + обновлено #}
          <div class="game-meta">
            <span class="gd-meta-label">Автор:</span>
            <a class="gd-comment-author" href="{% url 'profile-view' review.author.id %}">
              {{ review.author.profile.nickname|default:review.author.username }}
            </a>
            <div> <span class="gd-meta-label">Обновлено:</span> <span class="gd-meta-value">{{ review.updated_at|date:"d.m.Y" }}</span></div>
          </div>

          <div class="game-footer">
            <a class="btn btn-secondary" href="{% url 'review_detail' review.pk %}">Подробнее</a>
          </div>

        </article>
      {% endif %}
      {% endfor %}

    </div>
  {% include 'pagination.html' with queryset=reviews %}
  {% else %}
  {% if adult_blocked_only %}
  <div class="center muted">
    {% if not user.is_authenticated %}
      Больше контента для зарегистрированных пользователей
    {% elif not user.profile.is_adult %}
      Больше контента для пользователей 16+
    {% else %}
      Обзоров ещё нет.
    {% endif %}
  </div>
{% else %}
  <div class="center muted">
    Обзоров ещё нет.
  </div>
{% endif %}
{% endif %}
  {% if reviews and has_more_adult %}
  <div class="center muted">
    {% if not user.is_authenticated %}
      Больше контента для зарегистрированных пользователей
    {% elif not user.profile.is_adult %}
      Больше контента для пользователей 16+
    {% endif %}
  </div>

{% endif %}

</section>
{% endblock %}